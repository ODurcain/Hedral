{% extends 'base.html' %}

{% block head %}
<title>Geometric Calculator</title>
{% endblock %}

{% block body %}
<h1>Geometric Calculator</h1>

    <h2>Set precision</h2>
    <form id="setPrecision">
        <label for="precision">Prescision (integer) sets the number of significant figures:</label><br>
        <input type="number" id="precision" name="precision" min="0" required><br>
        <button type="submit">Set Precision</button>
    </form>
    <div id="setPrecisionValue"></div>

    <h2>Calculate Smallest Bounding Box</h2>
    <form id="boundingBoxForm">
        <label for="points">3D Points (comma separated x,y,z):</label><br>
        <textarea id="points" name="points" rows="4" cols="50"></textarea><br>
        <button type="submit">Calculate</button>
    </form>
    <div id="boundingBoxResult"></div>
    <div id="boundingBoxPlot"></div>

    <h2>Rotate Mesh</h2>
    <form id="rotateMeshForm">
        <label for="rotateMesh">Mesh (comma separated x,y,z):</label><br>
        <textarea id="rotateMesh" name="rotateMesh" rows="4" cols="50"></textarea><br>
        <label for="angle">Angle (x.xx):</label>
        <input type="number" id="angle" name="angle" min="0" step="{{ precision }}" requried><br>
        <label for="axis">Axis:</label>
        <select id="axis" name="axis" required>
            <option value="X">X</option>
            <option value="Y">Y</option>
            <option value="Z">Z</option>
            <option value="XY">XY</option>
            <option value="XZ">XZ</option>
            <option value="YZ">YZ</option>
        </select><br>
        <button type="submit">Rotate</button>
    </form>
    <div id="rotateMeshResult"></div>
    <div id="rotateMeshPlot"></div>

    <h2>Move Mesh</h2>
    <form id="moveMeshForm">
        <label for="moveMesh">Mesh (comma separated x,y,z):</label><br>
        <textarea id="moveMesh" name="moveMesh" rows="4" cols="50"></textarea><br>
        <label for="xDirection">X-Direction (x.xx):</label>
    <!-- I want to note that this probably isn't the best way as 
        you have to adjust 'step' depending accuracy desired -->
        <input type="number" id="xDirection" name="xDirection" step="{{ precision }}" required><br>
        <label for="yDirection">Y-Direction (x.xx):</label>
        <input type="number" id="yDirection" name="yDirection" step="{{ precision }}" required><br>
        <label for="xDirection">Z-Direction (x.xx):</label>
        <input type="number" id="zDirection" name="zDirection" step="{{ precision }}" required><br>
        <button type="submit">Move</button>
    </form>
    <div id="moveMeshResult"></div>
    <div id="movMeshPlot"></div>

    <h2>Is it Convex?</h2>
    <form id="isConvexForm">
        <label for="convex">Mesh (comma separated x,y,z):</label><br>
        <textarea id="convex" name="convex" rows="4" cols="50"></textarea><br>
        <button type="submit">Convex?</button>
    </form>
    <div id="isConvexResult"></div>

    <h2>Scalars! Maybe</h2>

    <h2>Reflection? Possibly</h2>

    <h2>Shear?</h2>

    <h2>Rotate/Move Simultaneously! Also maybe</h2>

    <script>
        // Function to make API requests
        async function makeRequest(url, method, body = {}) {
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error:', error);
                return { error: 'An error occurred' };
            }
        }

        
        // Function to display plots
        function displayPlot(containerId, plotData) {
            const plotContainer = document.getElementById(containerId);
            plotContainer.innerHTML = ''; // Clear previous content
            const img = new Image();
            img.src = `data:image/png;base64,${plotData}`;
            plotContainer.appendChild(img);
        }

        // Event handler for precision
        document.getElementById('setPrecision').addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Get the precision value from the input
            const precisionInput = document.getElementById('precisionInput');
            const precisionValue = parseInt(precisionInput.value);
            
            // Calculate the step value based on the precision
            let stepValue = '0.';
            for (let i = 0; i < precisionValue; i++) {
                stepValue += '0';
            }
            stepValue += '1';
            
            // Set the step attribute of all elements with the class 'adjustable-step'
            const elements = document.querySelectorAll('.adjustable-step');
            elements.forEach(element => {
                element.setAttribute('step', stepValue);
            });
        });

        // Event listener for bounding box form submission
        document.getElementById('boundingBoxForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            const points = document.getElementById('points').value.trim().split('\n').map(line => line.split(',').map(parseFloat));
            const result = await makeRequest('/bounding_box', 'POST', { points: points });
            document.getElementById('boundingBoxResult').innerText = JSON.stringify(result);
            displayPlot('boundingBoxPlot', result.plot);
        });

        // Event listener for rotation form submission
        document.getElementById('rotateMeshForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            const points = document.getElementById('rotateMesh').value.trim().split('\n').map(line => line.split(',').map(parseFloat));
            const angle = parseFloat(document.getElementById('angle').value);
            const axis = document.getElementById('axis').value;
            const result = await makeRequest('/rotate_mesh', 'POST', { points: points, angle: angle, axis: axis });
            document.getElementById('rotateMeshResult').innerText = JSON.stringify(result);
            displayPlot('rotateMeshPlot', result.plot);
        });

        // Event listener for movement form submission
        document.getElementById('moveMeshForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            const points = document.getElementById('moveMesh').value.trim().split('\n').map(line => line.split(',').map(parseFloat));
            const xDir = parseFloat(document.getElementById('xDirection').value);
            const yDir = parseFloat(document.getElementById('yDirection').value);
            const zDir = parseFloat(document.getElementById('zDirection').value);
            const result = await makeRequest('/move_mesh', 'POST', { points: points, xDirection: xDir, yDirection: yDir, zDirection: zDir });
            document.getElementById('moveMeshResult').innerText = JSON.stringify(result);
            displayPlot('moveMeshPlot', result.plot);
        });

        // Event listener for is convex? form submission
        document.getElementById('isConvexForm').addEventListener('submit', async function (event) {
            event.preventDefault();
            const points = document.getElementById('convex').value.trim().split('\n').map(line => line.split(',').map(parseFloat));
            const result = await makeRequest('/is_convex', 'POST', { points: points });
            document.getElementById('isConvexResult').innerText = JSON.stringify(result);
        });

    </script>
{% endblock %}